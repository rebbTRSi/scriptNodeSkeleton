<html>
<body>
 <script src="dat.gui.min.js"></script>
    <script>
	var position = 0;
    var b0 = new Array();
    var y = 0;   
	var buffer = 512;
    var delay1 = 16;
    var delay2 = 32;
    var mulu1 = 0.24;
    var mulu2 = 0.04;
	
	var tr = -30;
	var ra = 20;
	var at = 0.001;
	var re = 1.1;
	var bo = 1;
	
    var controls = new function() {
        this.treshold = tr;
        this.ratio = ra;
        this.attack = at;
        this.release = re;
        }
    var gui = new dat.GUI();
		gui.add(controls, 'treshold',-96,0);
		gui.add(controls, 'ratio',1,64);
		gui.add(controls, 'attack',0.0001,0.5);
		gui.add(controls, 'release',0.0,10.5);
    
    var myScript = document.querySelector('script');
    var myPre = document.querySelector('pre');
    var playButton = document.querySelector('button');
      
    // Create AudioContext and buffer source
    var audioCtx = new AudioContext();
    source = audioCtx.createBufferSource();

    // Create a ScriptProcessorNode with a bufferSize of 4096 and a single input and output channel
    var scriptNode = audioCtx.createScriptProcessor(4096*2, 1, 1);
    console.log(scriptNode.bufferSize);

    // load in an audio track via XHR and decodeAudioData

    function getData() {
		request = new XMLHttpRequest();

        request.open('GET', 'loop.mp3', true);

        request.responseType = 'arraybuffer';


        request.onload = function() {
			var audioData = request.response;
			audioCtx.decodeAudioData(audioData, function(buffer) {
			myBuffer = buffer;   
			source.buffer = myBuffer;
        },
        function(e){"Error with decoding audio data" + e.err});
        }

        request.send();
      }
      // Give the node a function to process audio events
      scriptNode.onaudioprocess = function(audioProcessingEvent) {
      // The input buffer is the song we loaded earlier
       var input = audioProcessingEvent.inputBuffer.getChannelData(0);
       var output =audioProcessingEvent.outputBuffer.getChannelData(0);
	   	
		var kenv = 0;
		var kin = 0;
		
       for (var i = 0; i < output.length; i++) {
		
		var battack = 1 / (controls.attack*44100);
		var brelease = 1 / (controls.release*44100);
		
	for (var q = 0; q < output.length; q++) {
		kin += input[q] * 32768 ;
		}
	
		kin /= output.length;
		kin = Math.abs(kin) ;
		kenv = (kin > kenv ? (kenv*(1-battack)+kin*(1-battack)) : kenv*(1-brelease));
		
		var ihedroom =  20 * Math.log10(32768) ;
		var kenvd =  20 *  Math.log10(kenv+0.0001) - ihedroom ;
		
		var kreduce = (kenvd >= controls.treshold ? (kenvd - controls.treshold)*(controls.ratio-1) : 0);
		var areduce = kreduce / 512;
		output[i] = input[i] * Math.pow (10,(areduce/20.0)) * 1.2   ;
		kin = 0;
	  }
}
		getData();
        source.connect(scriptNode);
        scriptNode.connect(audioCtx.destination);
        source.start();
		
		source.onended = function() {
        source.disconnect(scriptNode);
        scriptNode.disconnect(audioCtx.destination);
      }
      
	  function lerp (a, b,f)
		{
		return a + f * (b - a);
		}
	  
      //output the script into the pre element
      myPre.innerHTML = myScript.innerHTML;
	
	

	  </script>
  </body>
</html>